#!/usr/bin/env bash
# http://www.bahmanm.com/blogs/command-line-options-how-to-parse-in-bash-using-getopt

BINDIR="`pwd`/bin"
RAILS_OPTS=""
RUBY="2.3.1"    # Default Ruby version
VERSION="0.2.0" # Version of the script

##
# Parse arguments

TEMP=`${BINDIR}/getopt -n bin/create -o a:hnpr:v -l api,help,no-api,rails:,ruby:,version -- "$@"`
eval set -- "$TEMP"

while true ; do
  case "$1" in
    -a|--rails)
      case "$2" in
        "")  shift 2 ;;
         *) RAILS=$2 ; shift 2 ;;
      esac ;;
    -n|--no-api)
      RAILS_OPTS+=" --no-api" ;
      shift 1 ;;
    -p|--api)
      RAILS_OPTS+=" --api" ;
      shift 1 ;;
    -h|--help)
      #              1         2         3         4         5         6         7
      #     1234567890123456789012345678901234567890123456789012345678901234567890123456789
      echo "Usage: bin/create [options] PATH"
      echo ""
      echo "  Handy script to create a new Rails application."
      echo "  Currently at version $VERSION."
      echo ""
      echo "Parameters:"
      echo ""
      echo "  PATH    Path to application you wish to create; can be an absolute or"
      echo "          relative path."
      echo ""
      echo "Options:"
      echo ""
      echo "  -a VERSION, --rails VERSION   Use specified version of Rails.  If omitted,"
      echo "                                defaults to latest version."
      echo ""
      echo "  -r VERSION, --ruby VERSION    Use specified version of Ruby.  If omitted,"
      echo "                                defautls to version $RUBY."
      echo ""
      echo "  -n,         --no-api          Create non-API application (requires"
      echo "                                Rails >= 5)"
      echo ""
      echo "  -p,         --api             Create API-only application (requires"
      echo "                                Rails >= 5)"
      exit 1 ;;
    -r|--ruby)
      case "$2" in
        "") shift 2 ;;
         *) RUBY=$2 ; shift 2 ;;
      esac ;;
    -v|--version)
      echo $VERSION
      exit 1 ;;
    --) shift ; break ;;
    *) echo "Internal error!" ; exit 1 ;;
  esac
done

if [ "$1" == "" ]
then
  echo "[31mMissing argument: Supply path to application to create.  Use -h option for"
  echo "more information.[0m"
  exit 1
fi

APPPATH=$1
APPNAME=`basename $APPPATH`

if [ -d "$APPPATH" ]
then
  echo "[31mDirectory $APPPATH already exist.[0m"
  exit 2
fi

echo "[32mCreate directory $APPPATH[0m"
mkdir "$APPPATH"

echo "[32mCreate $APPPATH/.ruby-* files[0m"
echo "ruby-$RUBY" > $APPPATH/.ruby-version
echo $APPNAME > $APPPATH/.ruby-gemset

# Bring in RVM as a shell function (https://rvm.io/workflow/scripting)
source "$HOME/.rvm/scripts/rvm"

echo "[32mCreate gemset \"$APPNAME\"[0m"
cd "$APPPATH"

if [ "$RAILS" == "" ]
then
  RAILS_VERSION=""
  echo "[32mInstall latest version of Rails[0m"
else
  RAILS_VERSION="--version $RAILS"
  echo "[32mInstall version $RAILS of Rails[0m"
fi

gem install $RAILS_VERSION rails

echo "[32mCreate the \"$APPNAME\" application[0m"
rails new . $RAILS_OPTS

echo ""
echo "[32mDone!  You can now cd into \"$APPPATH\" and start working.[0m"
echo ""

