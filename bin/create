#!/usr/bin/env bash
#
# Usage: bin/create [options] path/of/app
#
# -r=version, --ruby version    Version of Ruby to use
# -a=version, --rails version   Version of Rails to use
#
# http://www.bahmanm.com/blogs/command-line-options-how-to-parse-in-bash-using-getopt

RUBY="2.2.0"

TEMP=`getopt -n bin/create -o a:hr: -l rails:,help,ruby: -- "$@"`
eval set -- "$TEMP"

while true ; do
  case "$1" in
    -a|--rails)
      case "$2" in
        "")  shift 2 ;;
         *) RAILS=$2 ; shift 2 ;;
      esac ;;
    -h|--help)
      echo "Usage: bin/create [options] path/of/app"
      echo ""
      echo "  Handy script to create a new Rails application."
      echo ""
      echo "Options:"
      echo ""
      echo "  -a VERSION, --rails VERSION   Use specified version of Rails."
      echo "                                If omitted, use latest version."
      echo ""
      echo "  -r VERSION, --ruby VERSION    Use specified version of Ruby."
      echo "                                If omitted, use version $RUBY."
      echo ""
      exit 1 ;;
    -r|--ruby)
      case "$2" in
        "") shift 2 ;;
         *) RUBY=$2 ; shift 2 ;;
      esac ;;
    --) shift ; break ;;
    *) echo "Internal error!" ; exit 1 ;;
  esac
done

if [ "$1" == "" ]
then
  echo "[31mMissing argument: Supply name of application to create.[0m"
  exit 1
fi

APPPATH=$1
APPNAME=`basename $APPPATH`

if [ -d "$APPPATH" ]
then
  echo "[31mDirectory $APPPATH already exist.[0m"
  exit 2
fi

echo "[32mCreate directory $APPPATH[0m"
mkdir "$APPPATH"

echo "[32mCreate $APPPATH/.ruby files[0m"
echo "ruby-$RUBY" > $APPPATH/.ruby-version
echo $APPNAME > $APPPATH/.ruby-gemset

# Bring in RVM as a shell function (https://rvm.io/workflow/scripting)
source "$HOME/.rvm/scripts/rvm"

echo "[32mCreate gemset \"$APPNAME\"[0m"
cd "$APPPATH"

if [ "$RAILS" == "" ]
then
  RAILS_VERSION=""
  echo "[32mInstall latest version of Rails and create the \"$APPNAME\" application[0m"
else
  RAILS_VERSION="--version $RAILS"
  echo "[32mInstall version $RAILS of Rails and create the \"$APPNAME\" application[0m"
fi

gem install $RAILS_VERSION rails
rails new .

echo ""
echo "[32mDone!  You can now cd into \"$APPPATH\" and start working.[0m"
echo ""
